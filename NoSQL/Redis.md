## 一、Redis 基础概念

### 1. 什么是 Redis

Redis（Remote Dictionary Server）是一个开源的键值对存储数据库，数据保存在内存中，具有极高的读写性能，并提供持久化机制，将数据异步保存到硬盘。Redis 支持丰富的数据类型、持久化、主从复制、发布订阅、Lua 脚本等功能。



### 2. Redis 常用场景

- **缓存**：存储经常访问的热点数据，减少数据库访问压力。
- **分布式锁**：使用 Redis 的原子性操作保证锁的独占访问。
- **计数器**：用于各种计数场景，如浏览量统计、点赞等。
- **队列系统**：基于 Redis 的列表（List）实现生产者/消费者模型。
- **会话存储**：存储用户的会话数据，适用于分布式系统。

------







## 二、Redis 数据结构

### 1. **字符串（String）**

Redis 的字符串类型是最基本的数据类型，可以存储字符串、整数、浮点数，单个键最大可存储 512MB 的值。

- 常用命令：
  - `SET key value`：设置键值
  - `GET key`：获取键值
  - `INCR key`：将键值加 1，适用于计数场景
  - `APPEND key value`：在键值末尾追加内容





### 2. **哈希（Hash）**

哈希是一种键值对集合，适合存储对象，如用户信息。

- 常用命令：
  - `HSET key field value`：设置哈希表中的字段值
  - `HGET key field`：获取哈希表中的字段值
  - `HGETALL key`：获取哈希表的所有字段和值





### 3. **列表（List）**

列表是一组按顺序排列的字符串，适合做消息队列。

- 常用命令：
  - `LPUSH key value`：从左侧插入元素
  - `RPUSH key value`：从右侧插入元素
  - `LPOP key`：从左侧弹出元素
  - `RPOP key`：从右侧弹出元素
  - `LRANGE key start end`：获取指定范围的列表元素





### 4. **集合（Set）**

集合是无序的元素集合，集合中的元素是唯一的。

- 常用命令：
  - `SADD key value`：向集合中添加元素
  - `SREM key value`：从集合中删除元素
  - `SMEMBERS key`：获取集合的所有元素
  - `SISMEMBER key value`：检查元素是否在集合中





### 5. **有序集合（Sorted Set）**

有序集合类似于集合，但每个元素关联一个得分（score），通过得分排序。

- 常用命令：
  - `ZADD key score value`：向有序集合中添加元素并设置分数
  - `ZRANGE key start end`：按照分数从小到大获取元素
  - `ZREVRANGE key start end`：按照分数从大到小获取元素
  - `ZSCORE key value`：获取指定元素的分数

------







## 三、Redis 持久化

Redis 提供两种持久化方式，将内存中的数据保存到硬盘，避免数据丢失：

### 1. **RDB（Redis Database）**

RDB 是将数据在特定间隔内生成快照保存到硬盘中。适合不太频繁的数据保存，恢复速度较快。

- 配置参数：
  - `save 900 1`：在 900 秒内如果有 1 次写操作，则进行 RDB 持久化。
  - `save 300 10`：在 300 秒内如果有 10 次写操作，则进行 RDB 持久化。

### 2. **AOF（Append-Only File）**

AOF 通过记录每个写操作的日志将数据持久化，可以更频繁地同步数据，可靠性更高。日志文件会随着写操作增多而变大。

- 配置参数：
  - `appendonly yes`：开启 AOF 持久化。
  - `appendfsync always`：每次写操作都同步到 AOF 文件，安全但性能差。
  - `appendfsync everysec`：每秒同步一次（推荐）。

------





## 四、Redis 事务

Redis 事务保证一组命令的顺序执行，但它不保证所有命令的原子性。

- **MULTI**：开启事务
- **EXEC**：执行事务
- **DISCARD**：取消事务
- **WATCH key**：监听一个或多个键，避免并发冲突

------







## 五、Redis 主从复制

Redis 支持主从复制功能，主节点负责写入操作，从节点负责同步主节点的数据，提供读操作的扩展能力。

- 主从复制命令
  - `SLAVEOF host port`：从节点执行该命令，指定主节点地址和端口。
  - **自动同步**：当主节点数据更新时，从节点会自动同步。

主从复制可以用于提高系统的读写性能、实现高可用性。

------









## 六、Redis 集群

当单机 Redis 无法满足业务需求时，可以采用 Redis 集群，分布式存储数据，提高系统的扩展性和可用性。

- Redis 集群通过**分片**存储数据，将不同键值分配到不同节点。
- Redis 集群通过 Gossip 协议管理集群中的节点信息，并通过 **hash slot** 机制分配数据。

------









## 七、Redis 常见应用场景

### 1. **缓存**

Redis 最常用的场景就是缓存，它可以缓存数据库的查询结果，减少数据库的压力。常见策略包括：

- **LRU（Least Recently Used）**：最近最少使用策略，当内存不足时，清理最不常使用的数据。
- **TTL（Time to Live）**：为缓存数据设置过期时间，避免缓存雪崩。

### 2. **分布式锁**

Redis 的 `SETNX` 和 `EXPIRE` 命令可以实现分布式锁，保证不同节点之间的资源独占性。

```
SET lock_key my_value NX EX 10  # 设置 10 秒超时的分布式锁
```

### 3. **消息队列**

通过 Redis 的列表类型（List）实现简单的消息队列，生产者使用 `LPUSH` 插入消息，消费者使用 `RPOP` 消费消息。

### 4. **限流**

Redis 可以通过计数器实现限流，配合 `INCR` 和 `EXPIRE` 控制特定时间窗口内的请求次数，防止接口被刷爆。

------









## 八、Redis 性能优化

### 1. **合理设置过期时间**

对于缓存数据，应设置合理的过期时间，避免缓存长期占用内存。

### 2. **使用批量操作**

Redis 支持管道（Pipeline）技术，可以批量发送多个命令，减少网络往返次数。

### 3. **避免大键**

Redis 中的键值对应尽量保持轻量级，避免存储过大的数据，以防增加内存和网络负担。

### 4. **主从分离**

通过将读写操作分离，主节点负责写操作，从节点负责读操作，提高整体吞吐量。

------









## 九、Redis 常见问题与解决方案

### 1. **Redis 数据丢失**

可能原因：

- 没有开启持久化机制（RDB 或 AOF）。
- AOF 日志未及时同步。

解决方案：

- 开启 AOF，并配置 `appendfsync everysec`，保证每秒同步数据到磁盘。

### 2. **Redis 阻塞**

可能原因：

- 执行了复杂的查询或大数据量的操作，如 `KEYS`、`FLUSHALL`。

解决方案：

- 避免使用阻塞操作，使用 `SCAN` 代替 `KEYS`。

### 3. **内存不足**

可能原因：

- Redis 内存配置过小或数据量过大。

解决方案：

- 合理设置 `maxmemory` 限制，并配置淘汰策略如 `allkeys-lru`。